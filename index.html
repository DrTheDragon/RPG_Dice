<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<title>Dotor RPG: O Paranormal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
<style>
/* ========== ESTILOS ========== */
:root{
 --bg1:#111;--bg2:#000;--panel:#080808;--text:#e0e0e0;
 --border:#222;
}
body.light{
 --bg1:#e6e6e6;--bg2:#cfcfcf;--panel:#f5f5f5;--text:#111;
 --border:#bbb;
}
@keyframes roll{
 0%{transform:rotate(0) scale(1)}
 30%{transform:rotate(25deg) scale(1.05)}
 60%{transform:rotate(-20deg) scale(1.05)}
 100%{transform:rotate(0) scale(1)}
}
.dado.rolando{animation:roll .35s ease-in-out}
body{
 background:radial-gradient(circle at top,var(--bg1),var(--bg2));
 color:var(--text);
 font-family:'Special Elite',monospace;
 margin:0;min-height:100vh;
 display:flex;justify-content:center;align-items:center;
}
.wrapper{width:100%;display:flex;flex-direction:column;align-items:center}
.app{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:820px;max-width:95%}
.panel{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px
}
h2,h3{text-align:center;letter-spacing:2px}
h4{text-align:center;letter-spacing:1px;margin:10px 0 5px;font-size:1.1em}
.section{border-top:1px solid var(--border);margin-top:20px;padding-top:15px}
input,button,textarea{
 width:100%;padding:10px;margin-top:8px;
 background:transparent;border:1px solid var(--border);
 color:var(--text);text-align:center;
 font-family:'Special Elite',monospace;
 font-size:15px
}
textarea{min-height:140px;text-align:left}
button{cursor:pointer}
button:hover{background:rgba(255,255,255,.05)}
button:active{transform:scale(.97)}
.dado{font-size:58px;text-align:center;margin:10px 0}
.resultado{min-height:90px;text-align:center;margin-top:10px}
.controls{display:flex;gap:6px;flex-wrap:wrap}
.controls button{flex:1 1 48%}
.E{color:#ff4c4c}
.B{color:#4fa3ff}
.N{color:#9acd32}
.F{color:#777}
.historico{margin-top:15px;font-size:14px}
.historico ul{list-style:none;padding:0;margin:0;height:180px;overflow:hidden}
.historico li{padding:5px 6px;border-bottom:1px solid var(--border);line-height:1.3;min-height:28px;display:flex;align-items:center}
.fade-0{color:var(--text)}
.fade-1{color:var(--text)}
.fade-2{color:var(--text)}
.fade-3{color:#bbb}
.fade-4{color:#888}
.fade-5{color:#555}
.toggle{
 margin-bottom:15px;
 width:820px;
 max-width:95%;
 display:flex;
 justify-content:space-between;
 align-items:center;
 gap:10px;
}
.toggle button{
 width:auto;
 min-width:150px;
 flex:1;
}
.itens{width:820px;max-width:95%;margin-top:25px}
.nome-personagem{
 width:820px;
 max-width:95%;
 margin-bottom:15px;
 text-align:center;
}
.nome-personagem input{
 width:100%;
 max-width:100%;
 box-sizing:border-box;
}
.checkboxes-vida{
 display:flex;
 justify-content:space-between;
 margin:15px 0 10px 0;
}
.checkbox-vida{
 width:30px;
 height:30px;
 margin:0;
}
.checkboxes-status{
 margin-top:15px;
}
.checkbox-status{
 display:block;
 margin:8px 0;
}
.checkbox-status input{
 width:auto;
 margin-right:10px;
}
.atributos-extras{
 width:820px;
 max-width:95%;
 margin-top:25px;
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:20px;
}
.atributo-extra{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
}
.atributo-extra h3{
 margin-top:0;
 margin-bottom:15px;
}
.peso-container{
 width:820px;
 max-width:95%;
 margin-top:25px;
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
}
.peso-container h3{
 margin-top:0;
 margin-bottom:15px;
 text-align:center;
}
.peso-inputs{
 display:flex;
 flex-direction:column;
 gap:15px;
}
.peso-item{
 text-align:center;
}
.peso-item p{
 margin:8px 0;
}
.peso-buttons{
 margin-top:10px;
}
.exposicao-container{
 text-align:center;
 padding:10px 0;
}
.exposicao-input{
 margin-top:10px;
}
.exposicao-input input{
 width:150px;
 margin:0 auto;
 display:block;
}
.recursos{
 width:820px;
 max-width:95%;
 margin-top:25px;
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:20px;
}
.recurso-item{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
 text-align:center;
}
.recurso-item h3{
 margin-top:0;
 margin-bottom:15px;
}
.dados-personalizados{
 margin-top:15px;
}
.roll-details{
 margin-top:10px;
 font-size:14px;
 line-height:1.4;
}
.roll-details p{
 margin:5px 0;
}
.max-button{
 margin-top: 10px;
 width: 100%;
}
.file-input {
 display: none;
}
/* Mobile */
@media(max-width:768px){
 body{align-items:flex-start; padding:10px; justify-content:flex-start; min-height:100vh;}
 .wrapper{width:100%; align-items:center;}
 .app{grid-template-columns:1fr; width:100%; max-width:100%; gap:12px;}
 .atributos-extras{grid-template-columns:1fr; width:100%; gap:12px; margin-top:12px;}
 .recursos{grid-template-columns:1fr; width:100%; gap:12px; margin-top:12px;}
 .nome-personagem, .toggle, .itens, .atributos-extras, .peso-container{width:100%; max-width:100%;}
 .panel{padding:15px; width:100%; box-sizing:border-box;}
 .controls button{padding:8px; font-size:14px; min-height:40px;}
 .dado{font-size:48px; margin:5px 0;}
 .exposicao-input input{width:120px;}
 .section{margin-top:12px; padding-top:10px;}
 h2{font-size:1.3em; margin:5px 0; text-align:center;}
 h3{font-size:1.1em; margin:8px 0; text-align:center;}
 .historico{margin-top:10px;}
 .historico ul{height:165px; overflow:hidden !important;}
 .historico li{padding:4px 6px; font-size:13px; line-height:1.4; min-height:26px;}
 input, button, textarea{font-size:14px; padding:8px; margin-top:6px;}
 .resultado{min-height:70px; padding:8px 0; font-size:14px; text-align:center;}
 .toggle{flex-direction:column; gap:8px; align-items:center;}
 .toggle button{width:100%; max-width:250px;}
 .itens{margin-top:12px;}
 .recursos, .atributos-extras, .peso-container{margin-top:12px;}
 .checkboxes-vida{justify-content:center; gap:25px; margin:10px 0;}
 .checkbox-vida{width:28px; height:28px;}
 .checkboxes-status{margin-top:10px;}
 .checkbox-status{margin:5px 0; font-size:14px;}
 .atributo-extra, .recurso-item, .peso-container{text-align:center;}
 .roll-details{font-size:13px; max-height:80px; overflow:hidden;}
 .resultado{min-height:65px;}
}
@media(max-width:480px){
 .controls{flex-direction:row; gap:4px;}
 .controls button{flex:1 1 46%; margin-bottom:0; font-size:13px; padding:7px;}
 .checkboxes-vida{gap:20px;}
 .panel{padding:12px;}
 .historico{font-size:12px;}
 .historico ul{height:160px;}
 .dado{font-size:42px;}
 h2{font-size:1.2em;}
 h3{font-size:1em;}
 .section{margin-top:10px; padding-top:8px;}
 .resultado{min-height:60px; font-size:13px;}
 .max-button{padding:7px; font-size:13px;}
 .exposicao-input input{width:100px;}
 .checkbox-vida{width:25px; height:25px;}
 .exposicao-container{padding:5px 0;}
 .exposicao-input{margin-top:5px;}
 .historico ul{height:155px;}
 .historico li{min-height:25px;}
}
.painel-ficha, .painel-atributos {
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
 width:820px;
 max-width:95%;
 margin-top:25px;
}
.painel-ficha h2, .painel-atributos h2 {
 margin-top:0;
 margin-bottom:20px;
 text-align:center;
}
.atributo-item {
 display:flex;
 align-items:center;
 justify-content:space-between;
 background:var(--bg1);
 border:1px solid var(--border);
 padding:8px 12px;
 margin-bottom:8px;
 border-radius:4px;
}
.atributo-item span {
 font-weight:bold;
}
.atributo-item .acoes {
 display:flex;
 gap:8px;
}
.atributo-item button {
 width:auto;
 padding:4px 12px;
 margin:0;
}
@media(max-width:768px){
 .painel-ficha > div { grid-template-columns:1fr !important; }
 .painel-ficha div[style*="display:flex; gap:10px;"] { flex-direction:column; }
 .atributo-item { flex-direction:column; align-items:flex-start; gap:5px; }
 .atributo-item .acoes { width:100%; justify-content:space-between; }
}
.identidade-personagem {
 width:820px;
 max-width:95%;
 margin-bottom:20px;
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:20px;
}
.identidade-personagem h3 {
 margin-top:0;
 margin-bottom:15px;
 text-align:center;
}
.identidade-grid {
 display:grid;
 grid-template-columns:1fr 2fr;
 gap:15px;
}
.identidade-grid .foto-area {
 text-align:center;
}
.identidade-grid .foto-placeholder {
 width:120px;
 height:120px;
 background:var(--bg1);
 border:2px solid var(--border);
 margin:0 auto;
 display:flex;
 align-items:center;
 justify-content:center;
 border-radius:5px;
 font-size:12px;
 overflow:hidden;
}
.identidade-grid .foto-placeholder img {
 width:100%;
 height:100%;
 object-fit:cover;
}
.identidade-grid .dados-basicos {
 display:flex;
 flex-direction:column;
 gap:10px;
}
.identidade-grid .dados-basicos input,
.identidade-grid .dados-basicos textarea {
 width:100%;
 box-sizing:border-box;
}
@media(max-width:768px){
 .identidade-grid { grid-template-columns:1fr; }
}

/* NOVOS ESTILOS PARA LABELS DA IDENTIDADE */
.campo-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 5px;
}
.campo-label {
  font-size: 0.7em;
  opacity: 0.7;
  margin-bottom: 2px;
  text-align: left;
  letter-spacing: 0.5px;
}
.linha-flex {
  display: flex;
  gap: 10px;
}
.linha-flex .campo-group {
  flex: 1;
}
</style>
</head>
<body>
<div class="wrapper">

<div class="toggle">
<button onclick="toggleTema()">üåó Alternar Tema</button>
<button onclick="exportarDados()">üì§ Exportar Valores</button>
<button onclick="importarDados()">üì• Importar Valores</button>
<input type="file" id="fileInput" class="file-input" accept=".json,.txt" onchange="processarArquivo(this.files)">
</div>

<!-- ===== IDENTIDADE DO PERSONAGEM ===== -->
<div class="identidade-personagem">
  <h3>üìã IDENTIDADE</h3>
  <div class="identidade-grid">
    <div class="foto-area">
      <div class="foto-placeholder" id="fotoPlaceholder">üñºÔ∏è Foto</div>
      <input type="file" id="fotoInput" accept="image/*" style="margin-top:10px; font-size:12px; padding:5px; width:100%;">
      <small>(opcional)</small>
    </div>
    <div class="dados-basicos">
      <!-- Nome e Apelido com labels -->
      <div class="campo-group">
        <label class="campo-label">Nome</label>
        <input type="text" id="nomePersonagem" placeholder="Nome do Personagem">
      </div>
      <div class="campo-group">
        <label class="campo-label">Apelido</label>
        <input type="text" id="apelidoPersonagem" placeholder="Apelido">
      </div>
      <!-- Idade e Emprego -->
      <div class="linha-flex">
        <div class="campo-group">
          <label class="campo-label">Idade</label>
          <input type="number" id="idadePersonagem" placeholder="Idade" min="0" step="1">
        </div>
        <div class="campo-group">
          <label class="campo-label">Emprego</label>
          <input type="text" id="empregoPersonagem" placeholder="Emprego / Ex‚Äëemprego">
        </div>
      </div>
      <!-- Cidade Natal e Residente -->
      <div class="linha-flex">
        <div class="campo-group">
          <label class="campo-label">Cidade Natal</label>
          <input type="text" id="cidadeNatal" placeholder="Cidade Natal">
        </div>
        <div class="campo-group">
          <label class="campo-label">Cidade Residente</label>
          <input type="text" id="cidadeResidente" placeholder="Cidade Residente">
        </div>
      </div>
      <!-- Tamanho, Apar√™ncia, Deslocamento -->
      <div class="linha-flex">
        <div class="campo-group">
          <label class="campo-label">Tamanho (m)</label>
          <input type="number" id="tamanho" placeholder="Tamanho" min="0" step="0.01">
        </div>
        <div class="campo-group">
          <label class="campo-label">Apar√™ncia (1-20)</label>
          <input type="number" id="aparencia" placeholder="Apar√™ncia" min="1" max="20" step="1">
        </div>
        <div class="campo-group">
          <label class="campo-label">Deslocamento (m)</label>
          <input type="number" id="deslocamento" placeholder="Deslocamento" min="0" step="0.1">
        </div>
      </div>
      <!-- Caracter√≠sticas, Personalidade, Hist√≥ria com labels -->
      <div class="campo-group">
        <label class="campo-label">Caracter√≠sticas f√≠sicas</label>
        <textarea id="caracteristicasPersonagem" placeholder="altura, cabelo, olhos, marcas..." rows="2"></textarea>
      </div>
      <div class="campo-group">
        <label class="campo-label">Personalidade</label>
        <textarea id="personalidadePersonagem" placeholder="tra√ßos, medos, virtudes..." rows="2"></textarea>
      </div>
      <div class="campo-group">
        <label class="campo-label">Hist√≥ria / Antecedentes</label>
        <textarea id="historiaPersonagem" placeholder="Hist√≥ria" rows="3"></textarea>
      </div>
    </div>
  </div>
</div>

<div class="app">
  <!-- COLUNA 1: STATUS -->
  <div class="panel">
    <h2>üìä STATUS</h2>
    <div class="section">
      <h3>‚ù§Ô∏è Vida</h3>
      <input id="vidaMax" type="number" placeholder="Vida M√°xima">
      <p>Atual: <b><span id="vidaAtual">0</span></b></p>
      <div class="controls">
        <button onclick="alterar('vida',-1)">-1</button>
        <button onclick="alterar('vida',1)">+1</button>
        <button onclick="alterar('vida',-5)">-5</button>
        <button onclick="alterar('vida',5)">+5</button>
      </div>
      <button class="max-button" onclick="setVidaMaxima()">VIDA M√ÅXIMA</button>
      <div class="checkboxes-vida">
        <label><input type="checkbox" class="checkbox-vida" id="checkVida1"></label>
        <label><input type="checkbox" class="checkbox-vida" id="checkVida2"></label>
        <label><input type="checkbox" class="checkbox-vida" id="checkVida3"></label>
      </div>
      <div class="checkboxes-status">
        <label class="checkbox-status"><input type="checkbox" id="checkFerido"> ü©∏ Gravemente ferido</label>
        <label class="checkbox-status"><input type="checkbox" id="checkCaido"> ‚ò† Ca√≠do</label>
      </div>
    </div>
    <div class="section">
      <h3>üß† Sanidade</h3>
      <input id="sanMax" type="number" placeholder="Sanidade M√°xima">
      <p>Atual: <b><span id="sanAtual">0</span></b></p>
      <div class="controls">
        <button onclick="alterar('san',-1)">-1</button>
        <button onclick="alterar('san',1)">+1</button>
        <button onclick="alterar('san',-5)">-5</button>
        <button onclick="alterar('san',5)">+5</button>
      </div>
      <button class="max-button" onclick="setSanidadeMaxima()">SANIDADE M√ÅXIMA</button>
    </div>
    <div class="section">
      <h3>üò¥ Horas de Descanso</h3>
      <p>Atual: <b><span id="descansoAtual">0</span></b></p>
      <div class="controls">
        <button onclick="alterar('descanso',-1)">-1</button>
        <button onclick="alterar('descanso',1)">+1</button>
        <button onclick="alterar('descanso',-3)">-3</button>
        <button onclick="alterar('descanso',3)">+3</button>
      </div>
    </div>
  </div>

  <!-- COLUNA 2: TESTES -->
  <div class="panel">
    <h2>üé≤ TESTES</h2>
    <div class="section">
      <h3>Teste de Atributo</h3>
      <div class="dado" id="dadoAtributo">üé≤</div>
      <div id="listaAtributosPersonalizados" style="margin-bottom:15px;"></div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <input type="text" id="novoAtributoNome" placeholder="Nome (ex: For√ßa)" style="flex:2;">
        <input type="number" id="novoAtributoValor" min="1" max="20" placeholder="1‚Äì20" style="flex:1;">
        <button onclick="adicionarAtributoPersonalizado()" style="flex:1;">‚ûï</button>
      </div>
      <div class="resultado" id="resAtributo"></div>
      <div class="historico">
        <h3>üìú Hist√≥rico de Atributos</h3>
        <ul id="listaHistorico"></ul>
      </div>
    </div>
    <div class="section">
      <h3>Teste de Sanidade</h3>
      <div class="dado" id="dadoSanidade">üé≤</div>
      <button onclick="testeSanidade()">ROLAR D100</button>
      <div class="resultado" id="resSan"></div>
      <div class="historico">
        <h3>üß† Hist√≥rico de Sanidade</h3>
        <ul id="listaHistoricoSan"></ul>
      </div>
    </div>
    <div class="section">
      <h3>üéØ Dados Personalizados</h3>
      <p style="font-size:12px; margin-bottom:10px;">Ex: "2d6", "1d20+4", "2#d20", "2#d20+2#d3", "2d6-1d4"</p>
      <input id="dadoPersonalizado" type="text" placeholder="Digite a f√≥rmula">
      <button onclick="rolarDadoPersonalizado()">ROLAR DADOS</button>
      <div class="resultado" id="resDadoPersonalizado"></div>
      <div id="detalhesRolagem" class="roll-details"></div>
      <div class="historico">
        <h3>üé≤ Hist√≥rico de Dados</h3>
        <ul id="listaHistoricoDados"></ul>
      </div>
    </div>
  </div>
</div>

<!-- ATRIBUTOS EXTRAS -->
<div class="atributos-extras">
  <div class="atributo-extra">
    <h3>üëÅÔ∏è EXPOSI√á√ÉO PARANORMAL</h3>
    <div class="exposicao-container">
      <p>Valor: <b><span id="exposicaoValor">0</span>%</b></p>
      <div class="exposicao-input">
        <input id="exposicaoInput" type="number" min="0" max="100" value="0" placeholder="0-100">
      </div>
    </div>
    <h3 style="margin-top:30px;">üõ°Ô∏è DEFESA</h3>
    <input id="defesa" type="number" placeholder="Defesa" min="0" value="0">
  </div>
  <div class="atributo-extra">
    <h3>‚ú® PONTOS DE PODER</h3>
    <input id="poderMax" type="number" placeholder="Poder M√°ximo" min="0">
    <p>Atual: <b><span id="poderAtual">0</span></b></p>
    <div class="controls">
      <button onclick="alterar('poder',-1)">-1</button>
      <button onclick="alterar('poder',1)">+1</button>
      <button onclick="alterar('poder',-5)">-5</button>
      <button onclick="alterar('poder',5)">+5</button>
    </div>
  </div>
</div>

<!-- PESO -->
<div class="peso-container">
  <h3>‚öñÔ∏è PESO</h3>
  <div class="peso-inputs">
    <div class="peso-item"><input id="pesoMax" type="number" placeholder="Peso M√°ximo" min="0"></div>
    <div class="peso-item"><p>Atual: <b><span id="pesoAtual">0</span></b></p></div>
    <div class="peso-item peso-buttons">
      <div class="controls">
        <button onclick="alterar('peso',-1)">-1</button>
        <button onclick="alterar('peso',1)">+1</button>
        <button onclick="alterar('peso',-5)">-5</button>
        <button onclick="alterar('peso',5)">+5</button>
      </div>
    </div>
  </div>
</div>

<!-- RECURSOS: DINHEIRO + TRAUMAS -->
<div class="recursos">
  <div class="recurso-item">
    <h3>üí∞ DINHEIRO</h3>
    <input id="dinheiro" type="text" placeholder="Dinheiro obtido">
  </div>
  <div class="recurso-item" style="display: flex; flex-direction: column; gap: 15px;">
    <div>
      <h4>üò® TRAUMAS PERMANENTES</h4>
      <textarea id="traumasPerm" placeholder="Traumas permanentes..." rows="3"></textarea>
    </div>
    <div>
      <h4>üò® TRAUMAS TEMPOR√ÅRIOS</h4>
      <textarea id="traumasTemp" placeholder="Traumas tempor√°rios..." rows="3"></textarea>
    </div>
  </div>
</div>

<!-- PESSOAS IMPORTANTES E TALENTOS -->
<div class="recursos" style="margin-top:25px;">
  <div class="recurso-item">
    <h3>üë• PESSOAS IMPORTANTES</h3>
    <textarea id="pessoasImportantes" placeholder="Pessoas importantes na vida do personagem..." rows="4"></textarea>
  </div>
  <div class="recurso-item">
    <h3>‚≠ê TALENTOS</h3>
    <textarea id="talentos" placeholder="Habilidades especiais, talentos..." rows="4"></textarea>
  </div>
</div>

<!-- ITENS -->
<div class="panel itens">
  <h2>üéí ITENS / ACESS√ìRIOS</h2>
  <textarea id="itens" placeholder="Armas, acess√≥rios,..."></textarea>
</div>

<!-- ANOTA√á√ïES -->
<div class="panel itens" style="margin-top:25px;">
  <h2>üìù ANOTA√á√ïES</h2>
  <textarea id="anotacoes" placeholder="Suas anota√ß√µes gerais..."></textarea>
</div>

</div> <!-- fecha wrapper -->

<script>
// ==================== VARI√ÅVEIS GLOBAIS ====================
let audioContext = null;
let audioInitialized = false;

let historico = [];
let historicoSan = [];
let historicoDados = [];

let vida = 0, san = 0, descanso = 0, poder = 0, peso = 0, defesa = 0, exposicao = 0;

const tabela = {
  1:{N:20,B:null,E:null},2:{N:19,B:20,E:null},3:{N:18,B:20,E:null},
  4:{N:17,B:19,E:null},5:{N:16,B:19,E:20},6:{N:15,B:18,E:20},
  7:{N:14,B:18,E:20},8:{N:13,B:17,E:20},9:{N:12,B:17,E:20},
  10:{N:11,B:16,E:19},11:{N:10,B:16,E:19},12:{N:9,B:15,E:19},
  13:{N:8,B:15,E:19},14:{N:7,B:14,E:19},15:{N:6,B:14,E:18},
  16:{N:5,B:13,E:18},17:{N:4,B:13,E:18},18:{N:3,B:12,E:18},
  19:{N:2,B:12,E:18},20:{N:1,B:11,E:17}
};

// ==================== √ÅUDIO ====================
function initAudio() {
  if (!audioInitialized) {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioInitialized = true;
    } catch(e) { return false; }
  }
  return true;
}
function somDado() {
  if (!initAudio()) return;
  if (audioContext.state === 'suspended') audioContext.resume();
  let t = audioContext.currentTime;
  for(let i=0;i<8;i++) {
    try {
      const o = audioContext.createOscillator();
      const g = audioContext.createGain();
      o.frequency.value = 120 + Math.random()*400;
      g.gain.setValueAtTime(0.15,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+0.08);
      o.connect(g); g.connect(audioContext.destination);
      o.start(t); o.stop(t+0.08);
      t += 0.04;
    } catch(e) { break; }
  }
}

// ==================== TESTES ====================
function testeAtributo(nome, valorAtributo) {
  somDado();
  let att = Math.min(20, Math.max(1, valorAtributo));
  const dadoEl = document.getElementById('dadoAtributo');
  if (dadoEl) { dadoEl.classList.add("rolando"); setTimeout(()=>dadoEl.classList.remove("rolando"),350); }
  const d = Math.floor(Math.random()*20)+1;
  let t,c; const r = tabela[att];
  if(d===1) { if(d>=r.N) { t="NORMAL"; c="N"; } else { t="FALHA CR√çTICA"; c="F"; } }
  else { if(r.E && d>=r.E) { t="EXTREMO"; c="E"; } else if(r.B && d>=r.B) { t="BOM"; c="B"; } else if(d>=r.N) { t="NORMAL"; c="N"; } else { t="FALHA"; c="F"; } }
  document.getElementById('resAtributo').innerHTML = `üé≤ ${d}<br>üìä ${nome}: ${att}<br><span class="${c}"><b>${t}</b></span>`;
  historico.unshift(`üé≤ ${d} | ${nome}: ${att} ‚Üí ${t}`);
  if(historico.length>6) historico.pop();
  salvar(); atualizarHistorico();
}
function testeSanidade() {
  somDado();
  const dadoEl = document.getElementById('dadoSanidade');
  if(dadoEl){ dadoEl.classList.add("rolando"); setTimeout(()=>dadoEl.classList.remove("rolando"),350); }
  const sanAtualVal = Math.max(0,san);
  const d = Math.floor(Math.random()*100)+1;
  const ok = d >= sanAtualVal;
  const r = ok ? "SUCESSO" : "FALHA";
  document.getElementById('resSan').innerHTML = `üé≤ ${d}<br>Sanidade Atual: ${sanAtualVal}<br><span class="${ok?'N':'F'}"><b>${r}</b></span>`;
  historicoSan.unshift(`üß† ${d} / San Atual: ${sanAtualVal} ‚Üí ${r}`);
  if(historicoSan.length>6) historicoSan.pop();
  salvar(); atualizarHistoricoSan();
}

// NOVA FUN√á√ÉO PARA DADOS PERSONALIZADOS (COM SUPORTE A +, - E COMBINA√á√ÉO DE #)
function rolarDadoPersonalizado() {
  somDado();
  let input = document.getElementById('dadoPersonalizado').value.trim();
  const resultadoDiv = document.getElementById('resDadoPersonalizado');
  const detalhesDiv = document.getElementById('detalhesRolagem');
  if (!input) { resultadoDiv.innerHTML = 'Digite uma f√≥rmula'; detalhesDiv.innerHTML = ''; return; }

  try {
    // Remove espa√ßos e converte para min√∫sculas
    input = input.replace(/\s+/g, '').toLowerCase();
    
    // Tokeniza a express√£o: captura n√∫meros, express√µes de dados e operadores +/-
    const tokenRegex = /(\d+#?d\d+|\d+|[+-])/g;
    const tokens = input.match(tokenRegex);
    if (!tokens) throw new Error('Express√£o inv√°lida');

    // Separa operandos e operadores
    const operadores = [];
    const operandos = [];
    for (let token of tokens) {
      if (token === '+' || token === '-') {
        operadores.push(token);
      } else {
        operandos.push(token);
      }
    }
    if (operandos.length === 0) throw new Error('Nenhum operando');
    if (operadores.length !== operandos.length - 1) throw new Error('N√∫mero de operandos e operadores incompat√≠vel');

    // Avalia cada operando (pode ser n√∫mero ou express√£o de dados)
    const resultados = operandos.map(op => avaliarOperando(op));
    
    // Verifica se h√° listas (resultados do tipo 'lista')
    const temLista = resultados.some(r => r.tipo === 'lista');
    
    // Se houver listas, todos os operandos devem ser convertidos para listas de mesmo tamanho
    let tamanhoLista = null;
    if (temLista) {
      // Descobre o tamanho da primeira lista (assumimos que todas t√™m o mesmo tamanho)
      for (let r of resultados) {
        if (r.tipo === 'lista') {
          if (tamanhoLista === null) tamanhoLista = r.valores.length;
          else if (r.valores.length !== tamanhoLista) throw new Error('Listas de tamanhos diferentes');
        }
      }
      // Converte operandos escalares para lista repetindo o valor
      const resultadosConvertidos = resultados.map(r => {
        if (r.tipo === 'escalar') {
          return Array(tamanhoLista).fill(r.valor);
        } else {
          return r.valores;
        }
      });
      
      // Combina as listas elemento a elemento com os operadores
      const listaFinal = [];
      for (let i = 0; i < tamanhoLista; i++) {
        let valor = resultadosConvertidos[0][i];
        for (let j = 0; j < operadores.length; j++) {
          const op = operadores[j];
          const prox = resultadosConvertidos[j+1][i];
          if (op === '+') valor += prox;
          else if (op === '-') valor -= prox;
        }
        listaFinal.push(valor);
      }
      
      // Exibe resultado
      resultadoDiv.innerHTML = `üé≤ ${input}<br>Resultados: <b>${listaFinal.join(', ')}</b>`;
      
      // Gera detalhes das rolagens individuais
      let detalhesHtml = '<p><b>Detalhes:</b></p>';
      operandos.forEach((op, idx) => {
        const r = resultados[idx];
        if (r.tipo === 'lista') {
          detalhesHtml += `${op}: [${r.valores.join(', ')}]<br>`;
        } else {
          detalhesHtml += `${op}: ${r.valor}<br>`;
        }
      });
      detalhesDiv.innerHTML = detalhesHtml;
      
      // Adiciona ao hist√≥rico
      historicoDados.unshift(`üé≤ ${input} ‚Üí [${listaFinal.join(', ')}]`);
    } else {
      // Todos s√£o escalares: faz a conta normalmente
      let total = resultados[0].valor;
      for (let j = 0; j < operadores.length; j++) {
        const op = operadores[j];
        const prox = resultados[j+1].valor;
        if (op === '+') total += prox;
        else if (op === '-') total -= prox;
      }
      resultadoDiv.innerHTML = `üé≤ ${input}<br>Total: <b>${total}</b>`;
      
      let detalhesHtml = '<p><b>Detalhes:</b></p>';
      operandos.forEach((op, idx) => detalhesHtml += `${op}: ${resultados[idx].valor}<br>`);
      detalhesDiv.innerHTML = detalhesHtml;
      
      historicoDados.unshift(`üé≤ ${input} ‚Üí ${total}`);
    }
    
    if (historicoDados.length > 6) historicoDados.pop();
    atualizarHistoricoDados();
    
  } catch (e) {
    resultadoDiv.innerHTML = 'Formato inv√°lido. Use express√µes como "2d6", "1d20+4", "2#d20", "2#d20+2#d3", "2d6-1d4".';
    detalhesDiv.innerHTML = '';
  }
}

// Avalia um token que pode ser um n√∫mero ou uma express√£o de dados (ex: "2d6", "2#d20")
function avaliarOperando(token) {
  // Se for apenas n√∫mero
  if (/^\d+$/.test(token)) {
    return { tipo: 'escalar', valor: parseInt(token) };
  }
  
  // Express√£o com dados
  if (token.includes('d')) {
    // Verifica se tem #
    if (token.includes('#')) {
      // Formato: qtd#dfaces
      const partes = token.split('#');
      if (partes.length !== 2) throw new Error('Formato # inv√°lido');
      const qtd = parseInt(partes[0]);
      const dadosPart = partes[1];
      if (!dadosPart.startsWith('d')) throw new Error('Esperado d ap√≥s #');
      const faces = parseInt(dadosPart.substring(1));
      if (isNaN(qtd) || qtd <= 0 || isNaN(faces) || faces <= 0) throw new Error('Valores inv√°lidos');
      
      const rolagens = [];
      for (let i = 0; i < qtd; i++) {
        rolagens.push(Math.floor(Math.random() * faces) + 1);
      }
      return { tipo: 'lista', valores: rolagens };
    } else {
      // Formato: qtddfaces ou dfaces (qtd=1 impl√≠cito)
      const dIndex = token.indexOf('d');
      const qtdStr = token.substring(0, dIndex) || '1';
      const facesStr = token.substring(dIndex + 1);
      const qtd = parseInt(qtdStr);
      const faces = parseInt(facesStr);
      if (isNaN(qtd) || qtd <= 0 || isNaN(faces) || faces <= 0) throw new Error('Valores inv√°lidos');
      
      let soma = 0;
      for (let i = 0; i < qtd; i++) {
        soma += Math.floor(Math.random() * faces) + 1;
      }
      return { tipo: 'escalar', valor: soma };
    }
  }
  
  throw new Error('Token n√£o reconhecido');
}

// ==================== STATUS ====================
function atualizar() {
  document.getElementById('vidaAtual').textContent = vida;
  document.getElementById('sanAtual').textContent = san;
  document.getElementById('descansoAtual').textContent = descanso;
  document.getElementById('poderAtual').textContent = poder;
  document.getElementById('pesoAtual').textContent = peso;
  document.getElementById('exposicaoValor').textContent = exposicao;
}
function alterar(t, v) {
  if(t==="vida") vida = Math.max(0, Math.min(+document.getElementById('vidaMax').value, vida+v));
  else if(t==="san") san = Math.max(0, Math.min(+document.getElementById('sanMax').value, san+v));
  else if(t==="descanso") descanso = Math.max(0, descanso+v);
  else if(t==="poder") poder = Math.max(0, Math.min(+document.getElementById('poderMax').value, poder+v));
  else if(t==="peso") peso = Math.max(0, Math.min(+document.getElementById('pesoMax').value, peso+v));
  salvar(); atualizar();
}
function setVidaMaxima() { vida = Math.max(0, +document.getElementById('vidaMax').value||0); atualizar(); salvar(); }
function setSanidadeMaxima() { san = Math.max(0, +document.getElementById('sanMax').value||0); atualizar(); salvar(); }
function atualizarExposicao() {
  let val = parseInt(document.getElementById('exposicaoInput').value)||0;
  if(val<0) val=0; if(val>100) val=100;
  exposicao = val;
  document.getElementById('exposicaoValor').textContent = exposicao;
  document.getElementById('exposicaoInput').value = exposicao;
  salvar();
}

// ==================== HIST√ìRICOS (com fade progressivo) ====================
function atualizarHistorico() {
  const lista = document.getElementById('listaHistorico');
  lista.innerHTML = "";
  historico.forEach((h, i) => {
    const li = document.createElement("li");
    // i=0,1,2 sem fade (fade-0, fade-1, fade-2 s√£o a cor normal)
    // i=3 fade-3, i=4 fade-4, i=5 fade-5
    li.className = i < 3 ? `fade-${i}` : i === 3 ? "fade-3" : i === 4 ? "fade-4" : "fade-5";
    li.textContent = h;
    lista.appendChild(li);
  });
}

function atualizarHistoricoSan() {
  const lista = document.getElementById('listaHistoricoSan');
  lista.innerHTML = "";
  historicoSan.forEach((h, i) => {
    const li = document.createElement("li");
    li.className = i < 3 ? `fade-${i}` : i === 3 ? "fade-3" : i === 4 ? "fade-4" : "fade-5";
    li.textContent = h;
    lista.appendChild(li);
  });
}

function atualizarHistoricoDados() {
  const lista = document.getElementById('listaHistoricoDados');
  lista.innerHTML = "";
  historicoDados.forEach((h, i) => {
    const li = document.createElement("li");
    li.className = i < 3 ? `fade-${i}` : i === 3 ? "fade-3" : i === 4 ? "fade-4" : "fade-5";
    li.textContent = h;
    lista.appendChild(li);
  });
}

// ==================== ATRIBUTOS PERSONALIZADOS ====================
let atributosPersonalizados = [];

function ordenarAtributos() {
  atributosPersonalizados.sort((a,b) => a.nome.localeCompare(b.nome));
}

function renderizarAtributos() {
  ordenarAtributos();
  const container = document.getElementById('listaAtributosPersonalizados');
  if(!container) return;
  container.innerHTML = '';
  atributosPersonalizados.forEach((attr, index) => {
    const div = document.createElement('div');
    div.className = 'atributo-item';
    div.innerHTML = `
      <span>${attr.nome}: ${attr.valor}</span>
      <div class="acoes">
        <button onclick="testeAtributo('${attr.nome}', ${attr.valor})" title="Rolar teste">üé≤</button>
        <button onclick="editarAtributo(${index})">‚úèÔ∏è</button>
        <button onclick="removerAtributo(${index})">üóëÔ∏è</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function adicionarAtributoPersonalizado() {
  const nomeInput = document.getElementById('novoAtributoNome');
  const valorInput = document.getElementById('novoAtributoValor');
  const nome = nomeInput.value.trim();
  const valor = parseInt(valorInput.value);
  if (!nome) { alert('Digite um nome.'); return; }
  if (isNaN(valor) || valor<1 || valor>20) { alert('Valor entre 1 e 20.'); return; }
  atributosPersonalizados.push({ nome, valor });
  ordenarAtributos();
  nomeInput.value = ''; valorInput.value = '';
  renderizarAtributos();
  salvar();
}

function editarAtributo(index) {
  const attr = atributosPersonalizados[index];
  const novoNome = prompt('Novo nome:', attr.nome);
  if(novoNome===null) return;
  const novoValor = prompt('Novo valor (1-20):', attr.valor);
  if(novoValor===null) return;
  const valorInt = parseInt(novoValor);
  if(novoNome.trim()==='' || isNaN(valorInt) || valorInt<1 || valorInt>20) {
    alert('Nome inv√°lido ou valor fora de 1-20.'); return;
  }
  atributosPersonalizados[index] = { nome: novoNome.trim(), valor: valorInt };
  ordenarAtributos();
  renderizarAtributos();
  salvar();
}

function removerAtributo(index) {
  if(confirm('Remover este atributo?')) {
    atributosPersonalizados.splice(index,1);
    ordenarAtributos();
    renderizarAtributos();
    salvar();
  }
}

// ==================== SALVAR / CARREGAR (localStorage) ====================
function salvar() {
  const fotoPlaceholder = document.getElementById('fotoPlaceholder');
  const img = fotoPlaceholder.querySelector('img');
  const imagemBase64 = img ? img.src : null;

  const dados = {
    vida, san, descanso, poder, peso, defesa, exposicao,
    vidaMax: Math.max(0, +document.getElementById('vidaMax').value || 0),
    sanMax: Math.max(0, +document.getElementById('sanMax').value || 0),
    poderMax: Math.max(0, +document.getElementById('poderMax').value || 0),
    pesoMax: Math.max(0, +document.getElementById('pesoMax').value || 0),
    dinheiro: document.getElementById('dinheiro').value,
    traumasPerm: document.getElementById('traumasPerm').value,
    traumasTemp: document.getElementById('traumasTemp').value,
    pessoasImportantes: document.getElementById('pessoasImportantes').value,
    talentos: document.getElementById('talentos').value,
    itens: document.getElementById('itens').value,
    anotacoes: document.getElementById('anotacoes').value,
    historico, historicoSan, historicoDados,
    tema: document.body.className,
    nomePersonagem: document.getElementById('nomePersonagem').value,
    apelido: document.getElementById('apelidoPersonagem').value,
    idade: document.getElementById('idadePersonagem').value,
    emprego: document.getElementById('empregoPersonagem').value,
    cidadeNatal: document.getElementById('cidadeNatal').value,
    cidadeResidente: document.getElementById('cidadeResidente').value,
    tamanho: document.getElementById('tamanho').value,
    aparencia: document.getElementById('aparencia').value,
    deslocamento: document.getElementById('deslocamento').value,
    caracteristicas: document.getElementById('caracteristicasPersonagem').value,
    personalidade: document.getElementById('personalidadePersonagem').value,
    historia: document.getElementById('historiaPersonagem').value,
    imagem: imagemBase64,
    checkVida1: document.getElementById('checkVida1').checked,
    checkVida2: document.getElementById('checkVida2').checked,
    checkVida3: document.getElementById('checkVida3').checked,
    checkFerido: document.getElementById('checkFerido').checked,
    checkCaido: document.getElementById('checkCaido').checked,
    atributosPersonalizados
  };
  localStorage.setItem('noir_rpg', JSON.stringify(dados));
}

function carregar() {
  const dadosSalvos = JSON.parse(localStorage.getItem('noir_rpg') || "null");
  if(!dadosSalvos) return;

  vida = dadosSalvos.vida || 0;
  san = dadosSalvos.san || 0;
  descanso = dadosSalvos.descanso || 0;
  poder = dadosSalvos.poder || 0;
  peso = dadosSalvos.peso || 0;
  defesa = dadosSalvos.defesa || 0;
  exposicao = dadosSalvos.exposicao || 0;
  document.getElementById('vidaMax').value = Math.max(0, dadosSalvos.vidaMax || 0);
  document.getElementById('sanMax').value = Math.max(0, dadosSalvos.sanMax || 0);
  document.getElementById('poderMax').value = Math.max(0, dadosSalvos.poderMax || 0);
  document.getElementById('pesoMax').value = Math.max(0, dadosSalvos.pesoMax || 0);
  document.getElementById('defesa').value = defesa;
  document.getElementById('exposicaoValor').textContent = exposicao;
  document.getElementById('exposicaoInput').value = exposicao;
  document.getElementById('dinheiro').value = dadosSalvos.dinheiro || "";
  document.getElementById('traumasPerm').value = dadosSalvos.traumasPerm || "";
  document.getElementById('traumasTemp').value = dadosSalvos.traumasTemp || "";
  document.getElementById('pessoasImportantes').value = dadosSalvos.pessoasImportantes || "";
  document.getElementById('talentos').value = dadosSalvos.talentos || "";
  document.getElementById('itens').value = dadosSalvos.itens || "";
  document.getElementById('anotacoes').value = dadosSalvos.anotacoes || "";
  historico = dadosSalvos.historico || [];
  historicoSan = dadosSalvos.historicoSan || [];
  historicoDados = dadosSalvos.historicoDados || [];
  if(dadosSalvos.tema) document.body.className = dadosSalvos.tema;
  document.getElementById('nomePersonagem').value = dadosSalvos.nomePersonagem || "";
  document.getElementById('apelidoPersonagem').value = dadosSalvos.apelido || "";
  document.getElementById('idadePersonagem').value = dadosSalvos.idade || "";
  document.getElementById('empregoPersonagem').value = dadosSalvos.emprego || "";
  document.getElementById('cidadeNatal').value = dadosSalvos.cidadeNatal || "";
  document.getElementById('cidadeResidente').value = dadosSalvos.cidadeResidente || "";
  document.getElementById('tamanho').value = dadosSalvos.tamanho || "";
  document.getElementById('aparencia').value = dadosSalvos.aparencia || "";
  document.getElementById('deslocamento').value = dadosSalvos.deslocamento || "";
  document.getElementById('caracteristicasPersonagem').value = dadosSalvos.caracteristicas || "";
  document.getElementById('personalidadePersonagem').value = dadosSalvos.personalidade || "";
  document.getElementById('historiaPersonagem').value = dadosSalvos.historia || "";
  if(dadosSalvos.imagem) {
    document.getElementById('fotoPlaceholder').innerHTML = `<img src="${dadosSalvos.imagem}" style="width:100%; height:100%; object-fit:cover;">`;
  }
  if(dadosSalvos.checkVida1!==undefined) document.getElementById('checkVida1').checked = dadosSalvos.checkVida1;
  if(dadosSalvos.checkVida2!==undefined) document.getElementById('checkVida2').checked = dadosSalvos.checkVida2;
  if(dadosSalvos.checkVida3!==undefined) document.getElementById('checkVida3').checked = dadosSalvos.checkVida3;
  if(dadosSalvos.checkFerido!==undefined) document.getElementById('checkFerido').checked = dadosSalvos.checkFerido;
  if(dadosSalvos.checkCaido!==undefined) document.getElementById('checkCaido').checked = dadosSalvos.checkCaido;
  if(dadosSalvos.atributosPersonalizados && Array.isArray(dadosSalvos.atributosPersonalizados)) {
    atributosPersonalizados = dadosSalvos.atributosPersonalizados;
    ordenarAtributos();
  }
  atualizar();
  atualizarHistorico();
  atualizarHistoricoSan();
  atualizarHistoricoDados();
  renderizarAtributos();
}

// ==================== EXPORTA√á√ÉO/IMPORTA√á√ÉO JSON ====================
function exportarDados() {
  const nome = document.getElementById('nomePersonagem').value || "PersonagemSemNome";
  const data = new Date().toLocaleDateString('pt-BR');
  const hora = new Date().toLocaleTimeString('pt-BR');
  const fotoPlaceholder = document.getElementById('fotoPlaceholder');
  const img = fotoPlaceholder.querySelector('img');
  const imagemBase64 = img ? img.src : null;

  const dadosParaExportar = {
    meta: { sistema:"Teste RPG", versao:"1.0", dataExportacao:new Date().toISOString(), dataLegivel:`${data} ${hora}`, nomePersonagem:nome },
    status: {
      vida:{ atual:vida, max:document.getElementById('vidaMax').value||0 },
      sanidade:{ atual:san, max:document.getElementById('sanMax').value||0 },
      descanso, poder:{ atual:poder, max:document.getElementById('poderMax').value||0 },
      peso:{ atual:peso, max:document.getElementById('pesoMax').value||0 },
      defesa, exposicaoParanormal:exposicao
    },
    estado: {
      gravementeFerido:document.getElementById('checkFerido').checked,
      caido:document.getElementById('checkCaido').checked,
      marcadoresVida: { marcador1:document.getElementById('checkVida1').checked,
                        marcador2:document.getElementById('checkVida2').checked,
                        marcador3:document.getElementById('checkVida3').checked }
    },
    recursos: {
      dinheiro:document.getElementById('dinheiro').value||"0",
      traumasPerm:document.getElementById('traumasPerm').value||"",
      traumasTemp:document.getElementById('traumasTemp').value||"",
      pessoasImportantes:document.getElementById('pessoasImportantes').value||"",
      talentos:document.getElementById('talentos').value||"",
      itens:document.getElementById('itens').value||"",
      anotacoes:document.getElementById('anotacoes').value||""
    },
    fichaPersonagem: {
      nome:document.getElementById('nomePersonagem').value,
      apelido:document.getElementById('apelidoPersonagem').value,
      idade:document.getElementById('idadePersonagem').value,
      emprego:document.getElementById('empregoPersonagem').value,
      cidadeNatal:document.getElementById('cidadeNatal').value,
      cidadeResidente:document.getElementById('cidadeResidente').value,
      tamanho:document.getElementById('tamanho').value,
      aparencia:document.getElementById('aparencia').value,
      deslocamento:document.getElementById('deslocamento').value,
      caracteristicas:document.getElementById('caracteristicasPersonagem').value,
      personalidade:document.getElementById('personalidadePersonagem').value,
      historia:document.getElementById('historiaPersonagem').value,
      imagem:imagemBase64
    },
    atributosPersonalizados,
    historicos: { testesAtributo:historico, testesSanidade:historicoSan, dadosPersonalizados:historicoDados },
    configuracao: { tema:document.body.className }
  };

  const jsonString = JSON.stringify(dadosParaExportar, null, 2);
  const blob = new Blob([jsonString], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ficha_rpg_${nome.replace(/\s+/g,'_')}_${data.replace(/\//g,'-')}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert(`Ficha de ${nome} exportada como JSON!`);
}

function importarDados() { document.getElementById('fileInput').click(); }
function processarArquivo(files) {
  if(files.length===0) return;
  const file = files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const dados = JSON.parse(e.target.result);
      aplicarDadosImportados(dados);
    } catch(error) {
      alert('Erro ao ler o arquivo. Formato inv√°lido.');
    }
  };
  reader.onerror = () => alert('Erro ao ler arquivo.');
  reader.readAsText(file);
}

function aplicarDadosImportados(dados) {
  if(!dados || !dados.status || !dados.meta) { alert('Arquivo inv√°lido.'); return; }
  if(dados.meta.nomePersonagem) document.getElementById('nomePersonagem').value = dados.meta.nomePersonagem;
  if(dados.status) {
    vida = dados.status.vida.atual||0; document.getElementById('vidaMax').value = dados.status.vida.max||0;
    san = dados.status.sanidade.atual||0; document.getElementById('sanMax').value = dados.status.sanidade.max||0;
    descanso = dados.status.descanso||0;
    poder = dados.status.poder.atual||0; document.getElementById('poderMax').value = dados.status.poder.max||0;
    peso = dados.status.peso.atual||0; document.getElementById('pesoMax').value = dados.status.peso.max||0;
    defesa = dados.status.defesa||0; document.getElementById('defesa').value = defesa;
    exposicao = dados.status.exposicaoParanormal||0; document.getElementById('exposicaoInput').value = exposicao;
  }
  if(dados.estado) {
    document.getElementById('checkFerido').checked = dados.estado.gravementeFerido||false;
    document.getElementById('checkCaido').checked = dados.estado.caido||false;
    if(dados.estado.marcadoresVida) {
      document.getElementById('checkVida1').checked = dados.estado.marcadoresVida.marcador1||false;
      document.getElementById('checkVida2').checked = dados.estado.marcadoresVida.marcador2||false;
      document.getElementById('checkVida3').checked = dados.estado.marcadoresVida.marcador3||false;
    }
  }
  if(dados.recursos) {
    document.getElementById('dinheiro').value = dados.recursos.dinheiro||"";
    document.getElementById('traumasPerm').value = dados.recursos.traumasPerm||"";
    document.getElementById('traumasTemp').value = dados.recursos.traumasTemp||"";
    document.getElementById('pessoasImportantes').value = dados.recursos.pessoasImportantes||"";
    document.getElementById('talentos').value = dados.recursos.talentos||"";
    document.getElementById('itens').value = dados.recursos.itens||"";
    document.getElementById('anotacoes').value = dados.recursos.anotacoes||"";
  }
  if(dados.historicos) {
    historico = dados.historicos.testesAtributo||[];
    historicoSan = dados.historicos.testesSanidade||[];
    historicoDados = dados.historicos.dadosPersonalizados||[];
    if(historico.length>6) historico = historico.slice(0,6);
    if(historicoSan.length>6) historicoSan = historicoSan.slice(0,6);
    if(historicoDados.length>6) historicoDados = historicoDados.slice(0,6);
  }
  if(dados.configuracao && dados.configuracao.tema) document.body.className = dados.configuracao.tema;
  if(dados.fichaPersonagem) {
    document.getElementById('apelidoPersonagem').value = dados.fichaPersonagem.apelido||"";
    document.getElementById('idadePersonagem').value = dados.fichaPersonagem.idade||"";
    document.getElementById('empregoPersonagem').value = dados.fichaPersonagem.emprego||"";
    document.getElementById('cidadeNatal').value = dados.fichaPersonagem.cidadeNatal||"";
    document.getElementById('cidadeResidente').value = dados.fichaPersonagem.cidadeResidente||"";
    document.getElementById('tamanho').value = dados.fichaPersonagem.tamanho||"";
    document.getElementById('aparencia').value = dados.fichaPersonagem.aparencia||"";
    document.getElementById('deslocamento').value = dados.fichaPersonagem.deslocamento||"";
    document.getElementById('caracteristicasPersonagem').value = dados.fichaPersonagem.caracteristicas||"";
    document.getElementById('personalidadePersonagem').value = dados.fichaPersonagem.personalidade||"";
    document.getElementById('historiaPersonagem').value = dados.fichaPersonagem.historia||"";
    if(dados.fichaPersonagem.imagem) {
      document.getElementById('fotoPlaceholder').innerHTML = `<img src="${dados.fichaPersonagem.imagem}" style="width:100%; height:100%; object-fit:cover;">`;
    }
  }
  if(dados.atributosPersonalizados && Array.isArray(dados.atributosPersonalizados)) {
    atributosPersonalizados = dados.atributosPersonalizados;
    ordenarAtributos();
  }
  atualizar();
  atualizarHistorico();
  atualizarHistoricoSan();
  atualizarHistoricoDados();
  renderizarAtributos();
  salvar();
  alert(`Dados de "${dados.meta.nomePersonagem||'Personagem'}" importados!`);
}

// ==================== UTILIT√ÅRIOS ====================
function calcularDinheiro() {
  const input = document.getElementById('dinheiro');
  const valor = input.value.trim();
  
  if(!valor) return;
  
  try {
    const validInput = valor.replace(/\s+/g, '');
    if(!/^[0-9+\-]+$/.test(validInput)) {
      const num = parseInt(valor) || 0;
      input.value = num;
      salvar();
      return;
    }
    
    const numeros = validInput.split(/([+-])/);
    let total = 0;
    let operador = '+';
    
    for(let parte of numeros) {
      if(parte === '+' || parte === '-') {
        operador = parte;
      } else if(parte !== '') {
        const num = parseInt(parte);
        if(!isNaN(num)) {
          if(operador === '+') {
            total += num;
          } else {
            total -= num;
          }
        }
      }
    }
    
    input.value = total;
    salvar();
    
  } catch(e) {
    const num = parseInt(valor) || 0;
    input.value = num;
    salvar();
  }
}
function toggleTema() { document.body.classList.toggle("light"); salvar(); }

// ==================== EVENTOS ====================
document.getElementById('fotoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      document.getElementById('fotoPlaceholder').innerHTML = `<img src="${event.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
      salvar();
    };
    reader.readAsDataURL(file);
  }
});

['vidaMax','sanMax','poderMax','pesoMax','defesa','exposicaoInput',
 'dinheiro','traumasPerm','traumasTemp','pessoasImportantes','talentos',
 'itens','anotacoes','nomePersonagem','apelidoPersonagem','idadePersonagem',
 'empregoPersonagem','cidadeNatal','cidadeResidente','tamanho','aparencia',
 'deslocamento','caracteristicasPersonagem','personalidadePersonagem','historiaPersonagem'
].forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', salvar);
});
['checkVida1','checkVida2','checkVida3','checkFerido','checkCaido'].forEach(id => {
  document.getElementById(id).addEventListener('change', salvar);
});

document.getElementById('exposicaoInput').addEventListener('input', atualizarExposicao);
document.getElementById('exposicaoInput').addEventListener('change', atualizarExposicao);

document.getElementById('dinheiro').addEventListener('blur', calcularDinheiro);
document.getElementById('dinheiro').addEventListener('keypress', e => { if(e.key==='Enter') calcularDinheiro(); });

document.getElementById('vidaMax').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  if(vida > this.value) vida = +this.value;
  salvar(); atualizar();
};
document.getElementById('sanMax').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  if(san > this.value) san = +this.value;
  salvar(); atualizar();
};
document.getElementById('poderMax').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  if(poder > this.value) poder = +this.value;
  salvar(); atualizar();
};
document.getElementById('pesoMax').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  if(peso > this.value) peso = +this.value;
  salvar(); atualizar();
};
document.getElementById('defesa').onchange = function() {
  defesa = Math.max(0, +this.value||0);
  salvar();
};

document.getElementById('idadePersonagem').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  salvar();
};
document.getElementById('tamanho').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  salvar();
};
document.getElementById('aparencia').onchange = function() {
  let val = +this.value;
  if (isNaN(val)) val = 1;
  val = Math.min(20, Math.max(1, val));
  this.value = val;
  salvar();
};
document.getElementById('deslocamento').onchange = function() {
  this.value = Math.max(0, +this.value||0);
  salvar();
};

document.getElementById('checkCaido').addEventListener('change', function() {
  if (this.checked) {
    document.getElementById('checkFerido').checked = true;
    salvar();
  }
});

// ==================== INICIALIZA√á√ÉO ====================
document.addEventListener('click', function initAudioOnClick() {
  if(!audioInitialized) initAudio();
  document.removeEventListener('click', initAudioOnClick);
});

carregar();
renderizarAtributos();
</script>
</body>
</html>