<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<title>Teste RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

<style>
/* Todos os estilos anteriores permanecem exatamente iguais */
:root{
 --bg1:#111;--bg2:#000;--panel:#080808;--text:#e0e0e0;
 --border:#222;
}
body.light{
 --bg1:#e6e6e6;--bg2:#cfcfcf;--panel:#f5f5f5;--text:#111;
 --border:#bbb;
}

@keyframes roll{
 0%{transform:rotate(0) scale(1)}
 30%{transform:rotate(25deg) scale(1.05)}
 60%{transform:rotate(-20deg) scale(1.05)}
 100%{transform:rotate(0) scale(1)}
}
.dado.rolando{animation:roll .35s ease-in-out}

body{
 background:radial-gradient(circle at top,var(--bg1),var(--bg2));
 color:var(--text);
 font-family:'Special Elite',monospace;
 margin:0;min-height:100vh;
 display:flex;justify-content:center;align-items:center;
}
.wrapper{width:100%;display:flex;flex-direction:column;align-items:center}
.app{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:820px;max-width:95%}
.panel{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px
}
h2,h3{text-align:center;letter-spacing:2px}
.section{border-top:1px solid var(--border);margin-top:20px;padding-top:15px}

input,button,textarea{
 width:100%;padding:10px;margin-top:8px;
 background:transparent;border:1px solid var(--border);
 color:var(--text);text-align:center;
 font-family:'Special Elite',monospace;
 font-size:15px
}
textarea{min-height:140px;text-align:left}
button{cursor:pointer}
button:hover{background:rgba(255,255,255,.05)}
button:active{transform:scale(.97)}

.dado{font-size:58px;text-align:center;margin:10px 0}
.resultado{min-height:90px;text-align:center;margin-top:10px}

.controls{display:flex;gap:6px;flex-wrap:wrap}
.controls button{flex:1 1 48%}

.E{color:#ff4c4c}
.B{color:#4fa3ff}
.N{color:#9acd32}
.F{color:#777}

.historico{margin-top:15px;font-size:14px}
.historico ul{list-style:none;padding:0;margin:0;height:180px;overflow:hidden}
.historico li{padding:5px 6px;border-bottom:1px solid var(--border);line-height:1.3;min-height:28px;display:flex;align-items:center}
.fade-0{color:var(--text);opacity:1}
.fade-1{color:var(--text);opacity:1}
.fade-2{color:var(--text);opacity:1}
.fade-3{color:var(--text);opacity:0.8}
.fade-4{color:var(--text);opacity:0.6}
.fade-5{color:var(--text);opacity:0.4}
.fade-6{color:var(--text);opacity:0.2}

.toggle{
 margin-bottom:15px;
 width:820px;
 max-width:95%;
 display:flex;
 justify-content:space-between;
 align-items:center;
}
.toggle button{
 width:auto;
 min-width:150px;
}

.itens{width:820px;max-width:95%;margin-top:25px}

/* Novos estilos adicionados */
.nome-personagem{
 width:820px;
 max-width:95%;
 margin-bottom:15px;
 text-align:center;
}
.nome-personagem input{
 width:100%;
 max-width:100%;
 box-sizing:border-box;
}

.checkboxes-vida{
 display:flex;
 justify-content:space-between;
 margin:15px 0 10px 0;
}
.checkbox-vida{
 width:30px;
 height:30px;
 margin:0;
}
.checkboxes-status{
 margin-top:15px;
}
.checkbox-status{
 display:block;
 margin:8px 0;
}
.checkbox-status input{
 width:auto;
 margin-right:10px;
}

/* Estilos para Atributos Extras */
.atributos-extras{
 width:820px;
 max-width:95%;
 margin-top:25px;
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:20px;
}
.atributo-extra{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
}
.atributo-extra h3{
 margin-top:0;
 margin-bottom:15px;
}

/* Estilos para Peso - um embaixo do outro */
.peso-container{
 width:820px;
 max-width:95%;
 margin-top:25px;
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
}
.peso-container h3{
 margin-top:0;
 margin-bottom:15px;
 text-align:center;
}
.peso-inputs{
 display:flex;
 flex-direction:column;
 gap:15px;
}
.peso-item{
 text-align:center;
}
.peso-item p{
 margin:8px 0;
}
.peso-buttons{
 margin-top:10px;
}

/* Estilos para Exposi√ß√£o Paranormal */
.exposicao-container{
 text-align:center;
 padding:10px 0;
}
.exposicao-input{
 margin-top:10px;
}
.exposicao-input input{
 width:150px;
 margin:0 auto;
 display:block;
}

/* Estilos para Recursos */
.recursos{
 width:820px;
 max-width:95%;
 margin-top:25px;
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:20px;
}
.recurso-item{
 background:var(--panel);
 border:1px solid var(--border);
 box-shadow:0 0 40px rgba(0,0,0,.7);
 padding:25px;
 text-align:center;
}
.recurso-item h3{
 margin-top:0;
 margin-bottom:15px;
}

/* Estilos para Dados Personalizados */
.dados-personalizados{
 margin-top:15px;
}
.roll-details{
 margin-top:10px;
 font-size:14px;
 line-height:1.4;
}
.roll-details p{
 margin:5px 0;
}

/* Estilo para os bot√µes de m√°ximo */
.max-button{
 margin-top: 10px;
 width: 100%;
}

/* Melhorias para mobile - HIST√ìRICOS VIS√çVEIS */
@media(max-width:768px){
 body{align-items:flex-start; padding:10px; justify-content:flex-start; min-height:100vh;}
 .wrapper{width:100%; align-items:center;}
 .app{grid-template-columns:1fr; width:100%; max-width:100%; gap:12px;}
 .atributos-extras{grid-template-columns:1fr; width:100%; gap:12px; margin-top:12px;}
 .recursos{grid-template-columns:1fr; width:100%; gap:12px; margin-top:12px;}
 .nome-personagem, .toggle, .itens, .atributos-extras, .peso-container{width:100%; max-width:100%;}
 .panel{padding:15px; width:100%; box-sizing:border-box;}
 .controls button{padding:8px; font-size:14px; min-height:40px;}
 .dado{font-size:48px; margin:5px 0;}
 .exposicao-input input{width:120px;}
 
 /* Ajuste para os pain√©is ficarem mais compactos */
 .section{margin-top:12px; padding-top:10px;}
 h2{font-size:1.3em; margin:5px 0; text-align:center;}
 h3{font-size:1.1em; margin:8px 0; text-align:center;}
 
 /* HIST√ìRICOS VIS√çVEIS NO MOBILE - MAIOR ALTURA */
 .historico{margin-top:10px;}
 .historico ul{height:165px; overflow:hidden !important;}
 .historico li{padding:4px 6px; font-size:13px; line-height:1.4; min-height:26px;}
 
 /* Melhor espa√ßamento geral */
 input, button, textarea{font-size:14px; padding:8px; margin-top:6px;}
 .resultado{min-height:70px; padding:8px 0; font-size:14px; text-align:center;}
 
 /* Centralizar melhor */
 .toggle{flex-direction:column; gap:10px; align-items:center;}
 .toggle button{width:100%; max-width:250px;}
 .itens{margin-top:12px;}
 .recursos, .atributos-extras, .peso-container{margin-top:12px;}
 
 /* Checkboxes de vida mais organizados */
 .checkboxes-vida{justify-content:center; gap:25px; margin:10px 0;}
 .checkbox-vida{width:28px; height:28px;}
 
 /* Status mais compactos */
 .checkboxes-status{margin-top:10px;}
 .checkbox-status{margin:5px 0; font-size:14px;}
 
 /* Centralizar melhor os containers */
 .atributo-extra, .recurso-item, .peso-container{text-align:center;}
 
 /* Rolagem de detalhes dos dados personalizados - SEM SCROLL */
 .roll-details{font-size:13px; max-height:80px; overflow:hidden;}
 
 /* Reduzir um pouco a altura dos resultados para dar mais espa√ßo aos hist√≥ricos */
 .resultado{min-height:65px;}
}

@media(max-width:480px){
 .controls{flex-direction:row; gap:4px;}
 .controls button{flex:1 1 46%; margin-bottom:0; font-size:13px; padding:7px;}
 .checkboxes-vida{gap:20px;}
 .panel{padding:12px;}
 .historico{font-size:12px;}
 .historico ul{height:160px;}
 .dado{font-size:42px;}
 
 /* T√≠tulos ajustados */
 h2{font-size:1.2em;}
 h3{font-size:1em;}
 
 /* Se√ß√µes mais compactas */
 .section{margin-top:10px; padding-top:8px;}
 .resultado{min-height:60px; font-size:13px;}
 
 /* Bot√µes menores mas funcionais */
 .max-button{padding:7px; font-size:13px;}
 
 /* Ajustes finos para melhor visualiza√ß√£o em telas muito pequenas */
 .exposicao-input input{width:100px;}
 .checkbox-vida{width:25px; height:25px;}
 
 /* Centralizar tudo melhor */
 .exposicao-container{padding:5px 0;}
 .exposicao-input{margin-top:5px;}
 
 /* Hist√≥ricos ainda mais vis√≠veis */
 .historico ul{height:155px;}
 .historico li{min-height:25px;}
}
</style>
</head>

<body>
<div class="wrapper">

<div class="toggle">
<button onclick="toggleTema()">üåó Alternar Tema</button>
<button onclick="exportarDados()">üì§ Exportar Dados</button>
</div>

<div class="nome-personagem">
<input id="nomePersonagem" type="text" placeholder="Nome do Personagem">
</div>

<div class="app">

<!-- COLUNA 1: TESTES -->
<div class="panel">
<h2>üé≤ TESTES</h2>

<div class="section">
<h3>Teste de Atributo</h3>
<input id="atributo" type="number" min="1" max="20" placeholder="Atributo (1‚Äì20)">
<div class="dado">üé≤</div>
<button onclick="testeAtributo()">ROLAR D20</button>
<div class="resultado" id="resAtributo"></div>

<div class="historico">
<h3>üìú Hist√≥rico</h3>
<ul id="listaHistorico"></ul>
</div>
</div>

<div class="section">
<h3>Teste de Sanidade</h3>
<div class="dado">üé≤</div>
<button onclick="testeSanidade()">ROLAR D100</button>
<div class="resultado" id="resSan"></div>

<div class="historico">
<h3>üß† Hist√≥rico de Sanidade</h3>
<ul id="listaHistoricoSan"></ul>
</div>
</div>

<div class="section">
<h3>üéØ Dados Personalizados</h3>
<p style="font-size:12px; margin-bottom:10px;">Exemplos: "2d6", "1d20+4", "1d20+1d10"</p>
<input id="dadoPersonalizado" type="text" placeholder="Digite a f√≥rmula (ex: 2d6)">
<button onclick="rolarDadoPersonalizado()">ROLAR DADOS</button>
<div class="resultado" id="resDadoPersonalizado"></div>
<div id="detalhesRolagem" class="roll-details"></div>

<div class="historico">
<h3>üé≤ Hist√≥rico de Dados Personalizados</h3>
<ul id="listaHistoricoDados"></ul>
</div>
</div>
</div>

<!-- COLUNA 2: STATUS -->
<div class="panel">
<h2>üìä STATUS</h2>

<div class="section">
<h3>‚ù§Ô∏è Vida</h3>
<input id="vidaMax" type="number" placeholder="Vida M√°xima">
<p>Atual: <b><span id="vidaAtual">0</span></b></p>
<div class="controls">
<button onclick="alterar('vida',-1)">-1</button>
<button onclick="alterar('vida',1)">+1</button>
<button onclick="alterar('vida',-5)">-5</button>
<button onclick="alterar('vida',5)">+5</button>
</div>
<button class="max-button" onclick="setVidaMaxima()">VIDA M√ÅXIMA</button>

<div class="checkboxes-vida">
<label><input type="checkbox" class="checkbox-vida" id="checkVida1"></label>
<label><input type="checkbox" class="checkbox-vida" id="checkVida2"></label>
<label><input type="checkbox" class="checkbox-vida" id="checkVida3"></label>
</div>

<div class="checkboxes-status">
<label class="checkbox-status">
 <input type="checkbox" id="checkFerido"> ü©∏ Gravemente ferido
</label>
<label class="checkbox-status">
 <input type="checkbox" id="checkCaido"> ‚ò† Ca√≠do
</label>
</div>
</div>

<div class="section">
<h3>üß† Sanidade</h3>
<input id="sanMax" type="number" placeholder="Sanidade M√°xima">
<p>Atual: <b><span id="sanAtual">0</span></b></p>
<div class="controls">
<button onclick="alterar('san',-1)">-1</button>
<button onclick="alterar('san',1)">+1</button>
<button onclick="alterar('san',-5)">-5</button>
<button onclick="alterar('san',5)">+5</button>
</div>
<button class="max-button" onclick="setSanidadeMaxima()">SANIDADE M√ÅXIMA</button>
</div>

<div class="section">
<h3>üò¥ Horas de Descanso</h3>
<p>Atual: <b><span id="descansoAtual">0</span></b></p>
<div class="controls">
<button onclick="alterar('descanso',-1)">-1</button>
<button onclick="alterar('descanso',1)">+1</button>
<button onclick="alterar('descanso',-3)">-3</button>
<button onclick="alterar('descanso',3)">+3</button>
</div>
</div>
</div>
</div>

<!-- ATRIBUTOS EXTRAS -->
<div class="atributos-extras">
<div class="atributo-extra">
<h3>üëÅÔ∏è EXPOSI√á√ÉO PARANORMAL</h3>
<div class="exposicao-container">
<p>Valor: <b><span id="exposicaoValor">0</span>%</b></p>
<div class="exposicao-input">
<input id="exposicaoInput" type="number" min="0" max="100" value="0" placeholder="0-100">
</div>
</div>

<h3 style="margin-top:30px;">üõ°Ô∏è DEFESA</h3>
<input id="defesa" type="number" placeholder="Defesa" min="0" value="0">
</div>

<div class="atributo-extra">
<h3>‚ú® PONTOS DE PODER</h3>
<input id="poderMax" type="number" placeholder="Poder M√°ximo" min="0">
<p>Atual: <b><span id="poderAtual">0</span></b></p>
<div class="controls">
<button onclick="alterar('poder',-1)">-1</button>
<button onclick="alterar('poder',1)">+1</button>
<button onclick="alterar('poder',-5)">-5</button>
<button onclick="alterar('poder',5)">+5</button>
</div>
</div>
</div>

<!-- PESO -->
<div class="peso-container">
<h3>‚öñÔ∏è PESO</h3>
<div class="peso-inputs">
<div class="peso-item">
<input id="pesoMax" type="number" placeholder="Peso M√°ximo" min="0">
</div>
<div class="peso-item">
<p>Atual: <b><span id="pesoAtual">0</span></b></p>
</div>
<div class="peso-item peso-buttons">
<div class="controls">
<button onclick="alterar('peso',-1)">-1</button>
<button onclick="alterar('peso',1)">+1</button>
<button onclick="alterar('peso',-5)">-5</button>
<button onclick="alterar('peso',5)">+5</button>
</div>
</div>
</div>
</div>

<!-- RECURSOS -->
<div class="recursos">
<div class="recurso-item">
<h3>üí∞ DINHEIRO</h3>
<input id="dinheiro" type="text" placeholder="Dinheiro obtido">
</div>

<div class="recurso-item">
<h3>üò® TRAUMAS</h3>
<textarea id="traumas" placeholder="Anote seus traumas e fobias aqui..."></textarea>
</div>
</div>

<!-- ITENS -->
<div class="panel itens">
<h2>üéí ITENS / ACESS√ìRIOS</h2>
<textarea id="itens" placeholder="Anota aqui armas, pistas, acess√≥rios, contatos, segredos..."></textarea>
</div>

</div>

<script>
// Sistema de som melhorado
let audioContext = null;
let audioInitialized = false;

function initAudio() {
 if (!audioInitialized) {
  try {
   audioContext = new (window.AudioContext || window.webkitAudioContext)();
   audioInitialized = true;
  } catch(e) {
   console.log("√Åudio n√£o suportado pelo navegador");
   return false;
  }
 }
 return true;
}

function somDado(){
 if (!initAudio()) return;
 
 if (audioContext.state === 'suspended') {
  audioContext.resume();
 }
 
 let t = audioContext.currentTime;
 for(let i = 0; i < 8; i++){
  try {
   const o = audioContext.createOscillator();
   const g = audioContext.createGain();
   o.frequency.value = 120 + Math.random() * 400;
   g.gain.setValueAtTime(0.15, t);
   g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
   o.connect(g);
   g.connect(audioContext.destination);
   o.start(t);
   o.stop(t + 0.08);
   t += 0.04;
  } catch(e) {
   console.log("Erro ao tocar som do dado");
   break;
  }
 }
}

let historico=[];
let historicoSan=[];
let historicoDados=[];

const tabela={
1:{N:20,B:null,E:null},2:{N:19,B:20,E:null},
3:{N:18,B:20,E:null},4:{N:17,B:19,E:null},
5:{N:16,B:19,E:20},6:{N:15,B:18,E:20},
7:{N:14,B:18,E:20},8:{N:13,B:17,E:20},
9:{N:12,B:17,E:20},10:{N:11,B:16,E:19},
11:{N:10,B:16,E:19},12:{N:9,B:15,E:19},
13:{N:8,B:15,E:19},14:{N:7,B:14,E:19},
15:{N:6,B:14,E:18},16:{N:5,B:13,E:18},
17:{N:4,B:13,E:18},18:{N:3,B:12,E:18},
19:{N:2,B:12,E:18},20:{N:1,B:11,E:17}
};

function testeAtributo(){
 somDado();
 let att=parseInt(atributo.value)||1;
 att=Math.min(20,Math.max(1,att));
 atributo.value=att;

 const dadoEl=document.querySelectorAll(".dado")[0];
 dadoEl.classList.add("rolando");
 setTimeout(()=>dadoEl.classList.remove("rolando"),350);

 const d=Math.floor(Math.random()*20)+1;
 let t,c;

 const r=tabela[att];
 
 if(d===1){
  if(d >= r.N){
   t="NORMAL";
   c="N";
  } else {
   t="FALHA CR√çTICA";
   c="F";
  }
 } else {
  if(r.E && d >= r.E){
   t="EXTREMO";
   c="E";
  } else if(r.B && d >= r.B){
   t="BOM";
   c="B";
  } else if(d >= r.N){
   t="NORMAL";
   c="N";
  } else {
   t="FALHA";
   c="F";
  }
 }

 resAtributo.innerHTML=
 `üé≤ ${d}<br>üìä Atributo ${att}<br><span class="${c}"><b>${t}</b></span>`;

 historico.unshift(`üé≤ ${d} | Atributo ${att} ‚Üí ${t}`);
 if(historico.length>6)historico.pop();
 salvar();atualizarHistorico();
}

function testeSanidade(){
 somDado();

 const dadoEl=document.querySelectorAll(".dado")[1];
 dadoEl.classList.add("rolando");
 setTimeout(()=>dadoEl.classList.remove("rolando"),350);

 // MODIFICA√á√ÉO: Agora compara com a sanidade ATUAL, n√£o m√°xima
 const sanAtualVal = Math.max(0, san); // san √© a vari√°vel que guarda a sanidade atual

 const d=Math.floor(Math.random()*100)+1;
 const ok=d>=sanAtualVal;
 const r=ok?"SUCESSO":"FALHA";

 resSan.innerHTML=`üé≤ ${d}<br>Sanidade Atual: ${sanAtualVal}<br><span class="${ok?'N':'F'}"><b>${r}</b></span>`;

 historicoSan.unshift(`üß† ${d} / San Atual: ${sanAtualVal} ‚Üí ${r}`);
 if(historicoSan.length>6)historicoSan.pop();
 salvar();atualizarHistoricoSan();
}

function rolarDadoPersonalizado(){
 somDado();
 let input = document.getElementById('dadoPersonalizado').value.trim();
 const resultado = document.getElementById('resDadoPersonalizado');
 const detalhes = document.getElementById('detalhesRolagem');
 
 if(!input) {
  resultado.innerHTML = 'Digite uma f√≥rmula de dados';
  detalhes.innerHTML = '';
  return;
 }
 
 try {
  input = input.replace(/\s+/g, '').toLowerCase();
  
  const partes = input.split('+');
  let total = 0;
  let detalhesText = '';
  
  for(let parte of partes) {
   if(parte.includes('d')) {
    const [quantidadeStr, facesStr] = parte.split(/d/i);
    const quantidade = parseInt(quantidadeStr) || 1;
    const faces = parseInt(facesStr);
    
    if(isNaN(faces) || faces <= 0) {
     throw new Error('N√∫mero de faces inv√°lido');
    }
    
    detalhesText += `${parte}: `;
    let somaParte = 0;
    const rolagens = [];
    
    for(let i = 0; i < quantidade; i++) {
     const rolagem = Math.floor(Math.random() * faces) + 1;
     rolagens.push(rolagem);
     somaParte += rolagem;
    }
    
    detalhesText += rolagens.join(' + ');
    if(quantidade > 1) {
     detalhesText += ` = ${somaParte}`;
    }
    
    total += somaParte;
    detalhesText += '<br>';
   } 
   else {
    const valor = parseInt(parte);
    if(!isNaN(valor)) {
     total += valor;
     detalhesText += `+${valor} (b√¥nus)<br>`;
    }
   }
  }
  
  resultado.innerHTML = `üé≤ ${input}<br>Total: <b>${total}</b>`;
  detalhes.innerHTML = `<p><b>Detalhes:</b></p>${detalhesText}`;
  
  historicoDados.unshift(`üé≤ ${input} ‚Üí ${total}`);
  if(historicoDados.length>6)historicoDados.pop();
  salvar();atualizarHistoricoDados();
  
 } catch(e) {
  resultado.innerHTML = 'Formato inv√°lido. Use: "2d6", "1d20+4", etc.';
  detalhes.innerHTML = '';
 }
}

// Fun√ß√£o para calcular dinheiro automaticamente
function calcularDinheiro() {
 const input = document.getElementById('dinheiro');
 const valor = input.value.trim();
 
 if(!valor) return;
 
 try {
  const validInput = valor.replace(/\s+/g, '');
  if(!/^[0-9+\-]+$/.test(validInput)) {
   const num = parseInt(valor) || 0;
   input.value = num;
   salvar();
   return;
  }
  
  const numeros = validInput.split(/([+-])/);
  let total = 0;
  let operador = '+';
  
  for(let parte of numeros) {
   if(parte === '+' || parte === '-') {
    operador = parte;
   } else if(parte !== '') {
    const num = parseInt(parte);
    if(!isNaN(num)) {
     if(operador === '+') {
      total += num;
     } else {
      total -= num;
     }
    }
   }
  }
  
  input.value = total;
  salvar();
  
 } catch(e) {
  const num = parseInt(valor) || 0;
  input.value = num;
  salvar();
 }
}

// Fun√ß√µes para definir valores m√°ximos
function setVidaMaxima() {
 const max = Math.max(0, +vidaMax.value || 0);
 vida = max;
 atualizar();
 salvar();
}

function setSanidadeMaxima() {
 const max = Math.max(0, +sanMax.value || 0);
 san = max;
 atualizar();
 salvar();
}

// Fun√ß√£o para exportar dados
function exportarDados() {
 const nome = nomePersonagem.value || "PersonagemSemNome";
 const data = new Date().toLocaleDateString('pt-BR');
 const hora = new Date().toLocaleTimeString('pt-BR');
 
 let conteudo = `=== FICHA DE PERSONAGEM ===\n`;
 conteudo += `Nome: ${nome}\n`;
 conteudo += `Exportado em: ${data} √†s ${hora}\n\n`;
 
 // STATUS
 conteudo += `=== STATUS ===\n`;
 conteudo += `Vida: ${vida}/${vidaMax.value || 0}\n`;
 conteudo += `Sanidade: ${san}/${sanMax.value || 0}\n`;
 conteudo += `Descanso: ${descanso} horas\n`;
 conteudo += `Poder: ${poder}/${poderMax.value || 0}\n`;
 conteudo += `Peso: ${peso}/${pesoMax.value || 0}\n`;
 conteudo += `Defesa: ${defesa}\n`;
 conteudo += `Exposi√ß√£o Paranormal: ${exposicao}%\n\n`;
 
 // STATUS DE VIDA
 const ferido = checkFerido.checked ? "Sim" : "N√£o";
 const caido = checkCaido.checked ? "Sim" : "N√£o";
 const vida1 = checkVida1.checked ? "‚úì" : "‚úó";
 const vida2 = checkVida2.checked ? "‚úì" : "‚úó";
 const vida3 = checkVida3.checked ? "‚úì" : "‚úó";
 
 conteudo += `=== ESTADO ===\n`;
 conteudo += `Gravemente Ferido: ${ferido}\n`;
 conteudo += `Ca√≠do: ${caido}\n`;
 conteudo += `Marcadores de Vida: [${vida1}] [${vida2}] [${vida3}]\n\n`;
 
 // RECURSOS
 conteudo += `=== RECURSOS ===\n`;
 conteudo += `Dinheiro: ${dinheiro.value || "0"}\n\n`;
 
 if(traumas.value.trim()) {
  conteudo += `=== TRAUMAS & FOBIAS ===\n`;
  conteudo += `${traumas.value}\n\n`;
 }
 
 // ITENS
 if(itens.value.trim()) {
  conteudo += `=== ITENS / ACESS√ìRIOS ===\n`;
  conteudo += `${itens.value}\n\n`;
 }
 
 // HIST√ìRICOS
 conteudo += `=== HIST√ìRICO DE TESTES ===\n`;
 conteudo += `Testes de Atributo:\n`;
 historico.forEach(item => conteudo += `  ${item}\n`);
 
 conteudo += `\nTestes de Sanidade:\n`;
 historicoSan.forEach(item => conteudo += `  ${item}\n`);
 
 conteudo += `\nDados Personalizados:\n`;
 historicoDados.forEach(item => conteudo += `  ${item}\n`);
 
 // Criar e baixar arquivo
 const blob = new Blob([conteudo], { type: 'text/plain' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `ficha_${nome.replace(/\s+/g, '_')}_${data.replace(/\//g, '-')}.txt`;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);
 
 alert(`Ficha de ${nome} exportada com sucesso!`);
}

function atualizarHistorico(){
 listaHistorico.innerHTML="";
 historico.forEach((h,i)=>{
  const li=document.createElement("li");
  if(i===0) li.className = "fade-0";
  else if(i===1) li.className = "fade-1";
  else if(i===2) li.className = "fade-2";
  else if(i===3) li.className = "fade-3";
  else if(i===4) li.className = "fade-4";
  else if(i===5) li.className = "fade-5";
  else li.className = "fade-6";
  li.textContent=h;
  listaHistorico.appendChild(li);
 });
}

function atualizarHistoricoSan(){
 listaHistoricoSan.innerHTML="";
 historicoSan.forEach((h,i)=>{
  const li=document.createElement("li");
  if(i===0) li.className = "fade-0";
  else if(i===1) li.className = "fade-1";
  else if(i===2) li.className = "fade-2";
  else if(i===3) li.className = "fade-3";
  else if(i===4) li.className = "fade-4";
  else if(i===5) li.className = "fade-5";
  else li.className = "fade-6";
  li.textContent=h;
  listaHistoricoSan.appendChild(li);
 });
}

function atualizarHistoricoDados(){
 listaHistoricoDados.innerHTML="";
 historicoDados.forEach((h,i)=>{
  const li=document.createElement("li");
  if(i===0) li.className = "fade-0";
  else if(i===1) li.className = "fade-1";
  else if(i===2) li.className = "fade-2";
  else if(i===3) li.className = "fade-3";
  else if(i===4) li.className = "fade-4";
  else if(i===5) li.className = "fade-5";
  else li.className = "fade-6";
  li.textContent=h;
  listaHistoricoDados.appendChild(li);
 });
}

let vida=0,san=0,descanso=0,poder=0,peso=0,defesa=0,exposicao=0;
function salvar(){
 localStorage.setItem("noir",JSON.stringify({
  vida,san,descanso,poder,peso,defesa,exposicao,
  vidaMax:Math.max(0,+vidaMax.value||0),
  sanMax:Math.max(0,+sanMax.value||0),
  poderMax:Math.max(0,+poderMax.value||0),
  pesoMax:Math.max(0,+pesoMax.value||0),
  dinheiro:dinheiro.value,
  itens:itens.value,
  traumas:traumas.value,
  historico,
  historicoSan,
  historicoDados,
  tema:document.body.className,
  nomePersonagem:nomePersonagem.value,
  checkVida1:checkVida1.checked,
  checkVida2:checkVida2.checked,
  checkVida3:checkVida3.checked,
  checkFerido:checkFerido.checked,
  checkCaido:checkCaido.checked
 }));
}
function carregar(){
 const d=JSON.parse(localStorage.getItem("noir"));if(!d)return;
 
 vida=d.vida||0;san=d.san||0;descanso=d.descanso||0;
 poder=d.poder||0;peso=d.peso||0;defesa=d.defesa||0;exposicao=d.exposicao||0;
 
 vidaMax.value=Math.max(0,d.vidaMax||0);
 sanMax.value=Math.max(0,d.sanMax||0);
 poderMax.value=Math.max(0,d.poderMax||0);
 pesoMax.value=Math.max(0,d.pesoMax||0);
 
 defesaInput.value = defesa;
 
 exposicaoValor.textContent=exposicao;
 exposicaoInput.value=exposicao;
 
 dinheiro.value=d.dinheiro||"";
 
 itens.value=d.itens||"";
 traumas.value=d.traumas||"";
 historico=d.historico||[];
 historicoSan=d.historicoSan||[];
 historicoDados=d.historicoDados||[];
 if(d.tema)document.body.className=d.tema;
 if(d.nomePersonagem)nomePersonagem.value=d.nomePersonagem;
 if(d.checkVida1!==undefined)checkVida1.checked=d.checkVida1;
 if(d.checkVida2!==undefined)checkVida2.checked=d.checkVida2;
 if(d.checkVida3!==undefined)checkVida3.checked=d.checkVida3;
 if(d.checkFerido!==undefined)checkFerido.checked=d.checkFerido;
 if(d.checkCaido!==undefined)checkCaido.checked=d.checkCaido;
 
 atualizar();atualizarHistorico();atualizarHistoricoSan();atualizarHistoricoDados();
}
function atualizar(){
 vidaAtual.textContent=vida;
 sanAtual.textContent=san;
 descansoAtual.textContent=descanso;
 poderAtual.textContent=poder;
 pesoAtual.textContent=peso;
 exposicaoValor.textContent=exposicao;
}
function alterar(t,v){
 if(t==="vida")vida=Math.max(0,Math.min(+vidaMax.value,vida+v));
 else if(t==="san")san=Math.max(0,Math.min(+sanMax.value,san+v));
 else if(t==="descanso")descanso=Math.max(0,descanso+v);
 else if(t==="poder")poder=Math.max(0,Math.min(+poderMax.value,poder+v));
 else if(t==="peso")peso=Math.max(0,Math.min(+pesoMax.value,peso+v));
 salvar();atualizar();
}

function atualizarExposicao(){
 let valor = parseInt(exposicaoInput.value) || 0;
 if(valor < 0) valor = 0;
 if(valor > 100) valor = 100;
 exposicao = valor;
 exposicaoValor.textContent = exposicao;
 exposicaoInput.value = exposicao;
 salvar();
}

vidaMax.onchange=()=>{
 vidaMax.value=Math.max(0,+vidaMax.value||0);
 if(vida > vidaMax.value) vida = vidaMax.value;
 salvar();atualizar();
};
sanMax.onchange=()=>{
 sanMax.value=Math.max(0,+sanMax.value||0);
 if(san > sanMax.value) san = sanMax.value;
 salvar();atualizar();
};
poderMax.onchange=()=>{
 poderMax.value=Math.max(0,+poderMax.value||0);
 if(poder > poderMax.value) poder = poderMax.value;
 salvar();atualizar();
};
pesoMax.onchange=()=>{
 pesoMax.value=Math.max(0,+pesoMax.value||0);
 if(peso > pesoMax.value) peso = pesoMax.value;
 salvar();atualizar();
};

const defesaInput = document.getElementById('defesa');
defesaInput.onchange = () => {
 defesa = Math.max(0, +defesaInput.value || 0);
 salvar();
};

exposicaoInput.onchange=atualizarExposicao;
exposicaoInput.oninput=atualizarExposicao;

dinheiro.addEventListener('blur', calcularDinheiro);
dinheiro.addEventListener('keypress', function(e){
 if(e.key === 'Enter') {
  calcularDinheiro();
 }
});

itens.oninput=salvar;
traumas.oninput=salvar;
nomePersonagem.oninput=salvar;
checkVida1.onchange=salvar;
checkVida2.onchange=salvar;
checkVida3.onchange=salvar;
checkFerido.onchange=salvar;
checkCaido.onchange=salvar;

function toggleTema(){
 document.body.classList.toggle("light");
 salvar();
}

document.addEventListener('click', function initAudioOnClick() {
 if (!audioInitialized) {
  initAudio();
 }
 document.removeEventListener('click', initAudioOnClick);
});

carregar();
</script>
</body>
</html>